<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ML Inference Platform</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<style>
  :root {
    --bg: #0f1117;
    --surface: #1a1d27;
    --surface2: #232733;
    --border: #2d3141;
    --text: #e4e6eb;
    --text2: #8b8fa3;
    --accent: #6366f1;
    --accent-hover: #818cf8;
    --green: #22c55e;
    --green-bg: rgba(34,197,94,.12);
    --red: #ef4444;
    --red-bg: rgba(239,68,68,.12);
    --yellow: #eab308;
    --yellow-bg: rgba(234,179,8,.12);
    --blue: #3b82f6;
    --blue-bg: rgba(59,130,246,.12);
    --radius: 8px;
    --font: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    --mono: 'SF Mono', 'Fira Code', 'Cascadia Code', monospace;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: var(--font); background: var(--bg); color: var(--text); min-height: 100vh; }

  /* Layout */
  .shell { display: flex; min-height: 100vh; }
  .sidebar {
    width: 220px; background: var(--surface); border-right: 1px solid var(--border);
    padding: 24px 0; flex-shrink: 0; position: sticky; top: 0; height: 100vh;
  }
  .sidebar h1 {
    font-size: 14px; font-weight: 700; letter-spacing: .5px; text-transform: uppercase;
    color: var(--accent); padding: 0 20px; margin-bottom: 28px;
  }
  .sidebar h1 span { color: var(--text2); font-weight: 400; display: block; font-size: 11px; margin-top: 4px; text-transform: none; letter-spacing: 0; }
  .nav-item {
    display: block; padding: 10px 20px; color: var(--text2); text-decoration: none;
    font-size: 13px; font-weight: 500; cursor: pointer; border-left: 3px solid transparent;
    transition: all .15s;
  }
  .nav-item:hover { color: var(--text); background: var(--surface2); }
  .nav-item.active { color: var(--accent); border-left-color: var(--accent); background: var(--surface2); }
  .main { flex: 1; padding: 32px 40px; max-width: 1100px; }

  /* Tabs */
  .tab { display: none; }
  .tab.active { display: block; }

  /* Cards */
  .cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 28px; }
  .card {
    background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius);
    padding: 20px;
  }
  .card-label { font-size: 12px; color: var(--text2); text-transform: uppercase; letter-spacing: .5px; margin-bottom: 8px; }
  .card-value { font-size: 28px; font-weight: 700; }
  .card-sub { font-size: 12px; color: var(--text2); margin-top: 4px; }

  /* Tables */
  .tbl-wrap { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; margin-bottom: 24px; }
  .tbl-title { padding: 16px 20px; font-size: 14px; font-weight: 600; border-bottom: 1px solid var(--border); }
  table { width: 100%; border-collapse: collapse; font-size: 13px; }
  th { text-align: left; padding: 10px 16px; color: var(--text2); font-weight: 500; font-size: 11px; text-transform: uppercase; letter-spacing: .5px; border-bottom: 1px solid var(--border); background: var(--surface2); }
  td { padding: 12px 16px; border-bottom: 1px solid var(--border); }
  tr:last-child td { border-bottom: none; }
  tr:hover td { background: var(--surface2); }

  /* Badges */
  .badge {
    display: inline-block; padding: 3px 10px; border-radius: 12px;
    font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: .3px;
  }
  .badge-prod { background: var(--green-bg); color: var(--green); }
  .badge-staging { background: var(--yellow-bg); color: var(--yellow); }
  .badge-pass { background: var(--green-bg); color: var(--green); }
  .badge-fail { background: var(--red-bg); color: var(--red); }

  /* Buttons */
  .btn {
    padding: 6px 14px; border-radius: 6px; border: 1px solid var(--border);
    background: var(--surface2); color: var(--text); font-size: 12px; font-weight: 500;
    cursor: pointer; transition: all .15s;
  }
  .btn:hover { border-color: var(--accent); color: var(--accent); }
  .btn-accent { background: var(--accent); border-color: var(--accent); color: #fff; }
  .btn-accent:hover { background: var(--accent-hover); border-color: var(--accent-hover); }
  .btn-sm { padding: 4px 10px; font-size: 11px; }
  .btn-danger { border-color: var(--red); color: var(--red); }
  .btn-danger:hover { background: var(--red-bg); }

  /* Charts */
  .chart-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px; }
  .chart-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; }
  .chart-card h3 { font-size: 13px; color: var(--text2); margin-bottom: 16px; font-weight: 500; }

  /* Mono */
  .mono { font-family: var(--mono); font-size: 12px; }

  /* Forms */
  .form-row { display: flex; gap: 12px; align-items: end; margin-bottom: 20px; flex-wrap: wrap; }
  .form-group label { display: block; font-size: 11px; color: var(--text2); margin-bottom: 4px; text-transform: uppercase; letter-spacing: .3px; }
  .form-group input, .form-group select {
    padding: 8px 12px; border-radius: 6px; border: 1px solid var(--border);
    background: var(--surface2); color: var(--text); font-size: 13px; font-family: var(--font);
    min-width: 160px;
  }
  .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--accent); }

  /* Toast */
  .toast {
    position: fixed; bottom: 24px; right: 24px; padding: 12px 20px;
    border-radius: var(--radius); font-size: 13px; font-weight: 500;
    z-index: 1000; transition: opacity .3s; opacity: 0; pointer-events: none;
  }
  .toast.show { opacity: 1; }
  .toast-ok { background: var(--green); color: #fff; }
  .toast-err { background: var(--red); color: #fff; }

  /* Empty state */
  .empty { text-align: center; padding: 48px 20px; color: var(--text2); font-size: 14px; }
  .empty-icon { font-size: 32px; margin-bottom: 12px; }

  /* Responsive */
  @media (max-width: 768px) {
    .sidebar { display: none; }
    .main { padding: 20px; }
    .chart-row { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>
<div class="shell">
  <nav class="sidebar">
    <h1>ML Platform <span>Inference & Eval</span></h1>
    <a class="nav-item active" onclick="switchTab('overview')">Overview</a>
    <a class="nav-item" onclick="switchTab('registry')">Model Registry</a>
    <a class="nav-item" onclick="switchTab('shadow')">Shadow Traffic</a>
    <a class="nav-item" onclick="switchTab('slo')">SLO Policies</a>
    <a class="nav-item" onclick="switchTab('gates')">Gate History</a>
  </nav>

  <div class="main">

    <!-- ============================================================ -->
    <!-- OVERVIEW -->
    <!-- ============================================================ -->
    <div id="tab-overview" class="tab active">
      <h2 style="margin-bottom:24px;">Dashboard</h2>
      <div class="cards">
        <div class="card">
          <div class="card-label">Total Models</div>
          <div class="card-value">{{ models | length }}</div>
        </div>
        <div class="card">
          <div class="card-label">Production</div>
          {% set prod = models | selectattr('status','equalto','prod') | list %}
          <div class="card-value" style="color:var(--green)">{{ prod | length }}</div>
          {% if prod %}
          <div class="card-sub">{{ prod[0].model_name }}@{{ prod[0].model_version }}</div>
          {% endif %}
        </div>
        <div class="card">
          <div class="card-label">Shadow Requests</div>
          <div class="card-value">{{ shadow_total }}</div>
        </div>
        <div class="card">
          <div class="card-label">SLO Policies</div>
          <div class="card-value">{{ slo_policies | length }}</div>
        </div>
        <div class="card">
          <div class="card-label">Gate Checks</div>
          <div class="card-value">{{ gate_results | length }}</div>
          {% set passed_gates = gate_results | selectattr('passed') | list %}
          <div class="card-sub">{{ passed_gates | length }} passed / {{ gate_results | length - passed_gates | length }} failed</div>
        </div>
      </div>

      {% if prod_metrics %}
      <div class="tbl-wrap">
        <div class="tbl-title">Production Model Metrics</div>
        <table>
          <tr><th>Metric</th><th>Value</th></tr>
          {% for key, val in prod_metrics.items() %}
          <tr><td>{{ key }}</td><td class="mono">{{ val }}</td></tr>
          {% endfor %}
        </table>
      </div>
      {% endif %}
    </div>

    <!-- ============================================================ -->
    <!-- MODEL REGISTRY -->
    <!-- ============================================================ -->
    <div id="tab-registry" class="tab">
      <h2 style="margin-bottom:24px;">Model Registry</h2>
      {% if models %}
      <div class="tbl-wrap">
        <table>
          <thead>
            <tr><th>Model</th><th>Version</th><th>Architecture</th><th>Status</th><th>Accuracy</th><th>P95 (ms)</th><th>Created</th><th>Actions</th></tr>
          </thead>
          <tbody>
            {% for m in models %}
            <tr>
              <td class="mono">{{ m.model_name }}</td>
              <td class="mono">{{ m.model_version }}</td>
              <td><span class="badge" style="background:var(--blue-bg);color:var(--blue)">{{ m.architecture }}</span></td>
              <td><span class="badge badge-{{ m.status }}">{{ m.status }}</span></td>
              <td class="mono">{{ m.metrics_parsed.accuracy | default('-') }}</td>
              <td class="mono">{{ m.metrics_parsed.p95_ms | default('-') }}</td>
              <td style="color:var(--text2)">{{ m.created_at.strftime('%Y-%m-%d %H:%M') if m.created_at else '-' }}</td>
              <td>
                {% if m.status != 'prod' %}
                <button class="btn btn-sm" onclick="promote('{{ m.model_name }}','{{ m.model_version }}')">Promote</button>
                {% else %}
                <button class="btn btn-sm btn-danger" onclick="rollback('{{ m.model_name }}')">Rollback</button>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="empty"><div class="empty-icon">&#9744;</div>No models registered yet.<br>Run <code class="mono">make train</code> to get started.</div>
      {% endif %}
    </div>

    <!-- ============================================================ -->
    <!-- SHADOW TRAFFIC -->
    <!-- ============================================================ -->
    <div id="tab-shadow" class="tab">
      <h2 style="margin-bottom:24px;">Shadow / Canary Traffic</h2>

      {% if shadow_pairs %}
      <div class="cards">
        <div class="card">
          <div class="card-label">Total Comparisons</div>
          <div class="card-value">{{ shadow_total }}</div>
        </div>
        <div class="card">
          <div class="card-label">Agreement Rate</div>
          <div class="card-value" style="color:var({% if shadow_agg_rate >= 0.9 %}--green{% elif shadow_agg_rate >= 0.7 %}--yellow{% else %}--red{% endif %})">{{ (shadow_agg_rate * 100) | round(1) }}%</div>
        </div>
      </div>

      <div class="chart-row">
        <div class="chart-card">
          <h3>Agreement vs Disagreement</h3>
          <canvas id="agreeChart" height="200"></canvas>
        </div>
        <div class="chart-card">
          <h3>Avg Latency Comparison (ms)</h3>
          <canvas id="latencyChart" height="200"></canvas>
        </div>
      </div>

      <div class="tbl-wrap">
        <div class="tbl-title">Shadow Pair Summaries</div>
        <table>
          <thead><tr><th>Model</th><th>Prod</th><th>Shadow</th><th>Requests</th><th>Agreement</th><th>Avg Prod Latency</th><th>Avg Shadow Latency</th></tr></thead>
          <tbody>
          {% for s in shadow_pairs %}
            <tr>
              <td class="mono">{{ s.model_name }}</td>
              <td class="mono">{{ s.prod_version }}</td>
              <td class="mono">{{ s.shadow_version }}</td>
              <td>{{ s.total }}</td>
              <td><span class="badge {% if s.rate >= 0.9 %}badge-pass{% else %}badge-fail{% endif %}">{{ (s.rate * 100) | round(1) }}%</span></td>
              <td class="mono">{{ s.avg_prod_ms | round(2) }} ms</td>
              <td class="mono">{{ s.avg_shadow_ms | round(2) }} ms</td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="empty"><div class="empty-icon">&#128065;</div>No shadow traffic yet.<br>Send requests with <code class="mono">shadow_version</code> to start comparing.</div>
      {% endif %}
    </div>

    <!-- ============================================================ -->
    <!-- SLO POLICIES -->
    <!-- ============================================================ -->
    <div id="tab-slo" class="tab">
      <h2 style="margin-bottom:24px;">SLO Policies</h2>

      <div class="form-row">
        <div class="form-group">
          <label>Policy Name</label>
          <input id="slo-name" placeholder="e.g. prod_slo">
        </div>
        <div class="form-group">
          <label>Model Name</label>
          <input id="slo-model" placeholder="e.g. mnist_cnn">
        </div>
        <div class="form-group">
          <label>p95_ms_max</label>
          <input id="slo-p95" type="number" step="0.1" placeholder="50">
        </div>
        <div class="form-group">
          <label>accuracy_min</label>
          <input id="slo-acc" type="number" step="0.01" placeholder="0.95">
        </div>
        <button class="btn btn-accent" onclick="createSlo()">Create Policy</button>
      </div>

      {% if slo_policies %}
      <div class="tbl-wrap">
        <div class="tbl-title">Active Policies</div>
        <table>
          <thead><tr><th>Name</th><th>Model</th><th>Constraints</th><th>Actions</th></tr></thead>
          <tbody>
          {% for p in slo_policies %}
            <tr>
              <td class="mono">{{ p.name }}</td>
              <td class="mono">{{ p.model_name }}</td>
              <td class="mono">{{ p.constraints }}</td>
              <td>
                <button class="btn btn-sm btn-danger" onclick="deleteSlo('{{ p.name }}')">Delete</button>
              </td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="empty"><div class="empty-icon">&#9888;</div>No SLO policies defined yet.</div>
      {% endif %}

      <h3 style="margin: 24px 0 16px; font-size: 14px; color: var(--text2);">Run SLO Check</h3>
      <div class="form-row">
        <div class="form-group">
          <label>Model Name</label>
          <input id="chk-model" placeholder="mnist_cnn">
        </div>
        <div class="form-group">
          <label>Version</label>
          <input id="chk-version" placeholder="v1.0.0">
        </div>
        <div class="form-group">
          <label>Policy</label>
          <input id="chk-policy" placeholder="prod_slo">
        </div>
        <button class="btn btn-accent" onclick="runSloCheck()">Check</button>
      </div>
      <div id="slo-result"></div>
    </div>

    <!-- ============================================================ -->
    <!-- GATE HISTORY -->
    <!-- ============================================================ -->
    <div id="tab-gates" class="tab">
      <h2 style="margin-bottom:24px;">Gate History</h2>
      {% if gate_results %}
      <div class="tbl-wrap">
        <table>
          <thead><tr><th>Model</th><th>Candidate</th><th>Baseline / Policy</th><th>Result</th><th>Time</th><th>Details</th></tr></thead>
          <tbody>
          {% for g in gate_results %}
            <tr>
              <td class="mono">{{ g.model_name }}</td>
              <td class="mono">{{ g.candidate_version }}</td>
              <td class="mono">{{ g.baseline_version }}</td>
              <td><span class="badge {% if g.passed %}badge-pass{% else %}badge-fail{% endif %}">{% if g.passed %}PASS{% else %}FAIL{% endif %}</span></td>
              <td style="color:var(--text2)">{{ g.created_at.strftime('%Y-%m-%d %H:%M') if g.created_at else '-' }}</td>
              <td>
                {% if g.details_parsed and g.details_parsed.checks is defined %}
                  {% for c in g.details_parsed.checks %}
                    <span class="badge {% if c.passed %}badge-pass{% else %}badge-fail{% endif %}" style="margin-right:4px">{{ c.constraint if c.constraint is defined else c.check }}</span>
                  {% endfor %}
                {% elif g.details_parsed and g.details_parsed.error is defined %}
                  <span style="color:var(--red);font-size:12px">{{ g.details_parsed.error[:60] }}</span>
                {% else %}
                  -
                {% endif %}
              </td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="empty"><div class="empty-icon">&#128203;</div>No gate results yet.<br>Run the pipeline or an SLO check to generate results.</div>
      {% endif %}
    </div>

  </div>
</div>

<div id="toast" class="toast"></div>

<script>
function switchTab(name) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('tab-' + name).classList.add('active');
  document.querySelectorAll('.nav-item').forEach(n => {
    if (n.textContent.toLowerCase().replace(/[\s\/]/g,'').includes(name)) n.classList.add('active');
  });
}

function toast(msg, ok) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.className = 'toast show ' + (ok ? 'toast-ok' : 'toast-err');
  setTimeout(() => el.className = 'toast', 3000);
}

async function promote(modelName, version) {
  if (!confirm('Promote ' + modelName + '@' + version + ' to production?')) return;
  try {
    const r = await fetch('/dashboard/api/promote', {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({model_name: modelName, model_version: version})
    });
    const d = await r.json();
    if (r.ok) { toast('Promoted ' + version + ' to prod', true); setTimeout(() => location.reload(), 800); }
    else toast(d.detail || 'Promote failed', false);
  } catch(e) { toast('Error: ' + e.message, false); }
}

async function rollback(modelName) {
  if (!confirm('Rollback ' + modelName + ' to previous version?')) return;
  try {
    const r = await fetch('/dashboard/api/rollback', {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({model_name: modelName})
    });
    const d = await r.json();
    if (r.ok) { toast('Rolled back to ' + (d.model_version || 'previous'), true); setTimeout(() => location.reload(), 800); }
    else toast(d.detail || 'Rollback failed', false);
  } catch(e) { toast('Error: ' + e.message, false); }
}

async function createSlo() {
  const name = document.getElementById('slo-name').value;
  const model = document.getElementById('slo-model').value;
  const p95 = document.getElementById('slo-p95').value;
  const acc = document.getElementById('slo-acc').value;
  if (!name || !model) { toast('Name and model required', false); return; }
  const constraints = {};
  if (p95) constraints.p95_ms_max = parseFloat(p95);
  if (acc) constraints.accuracy_min = parseFloat(acc);
  if (Object.keys(constraints).length === 0) { toast('Add at least one constraint', false); return; }
  try {
    const r = await fetch('/slo/policies', {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({name, model_name: model, constraints})
    });
    if (r.ok) { toast('Policy created', true); setTimeout(() => location.reload(), 800); }
    else { const d = await r.json(); toast(d.detail || 'Failed', false); }
  } catch(e) { toast('Error: ' + e.message, false); }
}

async function deleteSlo(name) {
  if (!confirm('Delete policy "' + name + '"?')) return;
  try {
    const r = await fetch('/slo/policies/' + name, {method: 'DELETE'});
    if (r.ok) { toast('Deleted', true); setTimeout(() => location.reload(), 800); }
    else toast('Delete failed', false);
  } catch(e) { toast('Error: ' + e.message, false); }
}

async function runSloCheck() {
  const model = document.getElementById('chk-model').value;
  const version = document.getElementById('chk-version').value;
  const policy = document.getElementById('chk-policy').value;
  if (!model || !version || !policy) { toast('All fields required', false); return; }
  try {
    const r = await fetch('/slo/check', {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({model_name: model, model_version: version, policy_name: policy})
    });
    const d = await r.json();
    const el = document.getElementById('slo-result');
    if (r.ok) {
      let html = '<div class="tbl-wrap" style="margin-top:12px"><div class="tbl-title">Result: <span class="badge ' + (d.passed ? 'badge-pass' : 'badge-fail') + '">' + (d.passed ? 'PASS' : 'FAIL') + '</span></div><table><thead><tr><th>Constraint</th><th>Threshold</th><th>Actual</th><th>Status</th></tr></thead><tbody>';
      (d.checks||[]).forEach(c => {
        html += '<tr><td class="mono">' + c.constraint + '</td><td class="mono">' + c.threshold + '</td><td class="mono">' + (c.actual !== null && c.actual !== undefined ? c.actual : 'N/A') + '</td><td><span class="badge ' + (c.passed ? 'badge-pass' : 'badge-fail') + '">' + (c.passed ? 'PASS' : 'FAIL') + '</span></td></tr>';
      });
      html += '</tbody></table></div>';
      el.innerHTML = html;
    } else {
      el.innerHTML = '<p style="color:var(--red);margin-top:12px">' + (d.detail || 'Check failed') + '</p>';
    }
  } catch(e) { toast('Error: ' + e.message, false); }
}

/* Charts -- only render if shadow data exists */
{% if shadow_pairs %}
document.addEventListener('DOMContentLoaded', () => {
  const agreeData = {{ shadow_chart_agree | tojson }};
  const latData = {{ shadow_chart_latency | tojson }};

  new Chart(document.getElementById('agreeChart'), {
    type: 'doughnut',
    data: {
      labels: ['Agreed', 'Disagreed'],
      datasets: [{data: [agreeData.agreed, agreeData.disagreed], backgroundColor: ['#22c55e','#ef4444'], borderWidth: 0}]
    },
    options: {responsive: true, plugins: {legend: {labels: {color: '#8b8fa3'}}}}
  });

  new Chart(document.getElementById('latencyChart'), {
    type: 'bar',
    data: {
      labels: latData.labels,
      datasets: [
        {label: 'Prod (ms)', data: latData.prod, backgroundColor: '#3b82f6'},
        {label: 'Shadow (ms)', data: latData.shadow, backgroundColor: '#a855f7'}
      ]
    },
    options: {
      responsive: true,
      scales: {x: {ticks: {color:'#8b8fa3'}}, y: {ticks: {color:'#8b8fa3'}, grid: {color:'#2d3141'}}},
      plugins: {legend: {labels: {color: '#8b8fa3'}}}
    }
  });
});
{% endif %}
</script>
</body>
</html>
